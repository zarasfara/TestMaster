@page "/results"
@using TestMaster.Presentation.Services
@layout MainLayout
@inject NavigationManager NavigationManager
@inject IExamStateService ExamState
@inject IConnectivityService ConnectivityService

<div class="header-bar">
    <div class="header-title">Единый государственный экзамен Информатика и ИКТ (КЕГЭ)</div>
</div>

<div class="main-content" style="padding: 20px;">
    <h2 style="text-align: center; margin-bottom: 30px;">Результаты экзамена</h2>

    @{
        var primaryScore = CalculatePrimaryScore();
        var secondaryScore = ConvertToSecondary(primaryScore);
        const int maxPrimary = 29;
        const int maxSecondary = 100;
    }

    <!-- Блок "X/100" (вторичный балл) -->
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 64px; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
            @secondaryScore/@maxSecondary
        </div>
        <div style="color: #aaa; font-size: 16px; margin-top: 8px;">
            Первичный балл: @primaryScore/@maxPrimary
        </div>
    </div>

    <table class="results-table">
        <thead>
        <tr>
            <th>№</th>
            <th>Балл</th>
            <th>Ваш ответ</th>
        </tr>
        </thead>
        <tbody>
        @for (var i = 1; i <= 27; i++)
        {
            var userAnswer = ExamState.Answers.GetValueOrDefault(i, "");
            var (score, correctAnswer) = GetScoreAndCorrectAnswer(i, userAnswer);
            <tr>
                <td>@i</td>
                <td>@score</td>
                <td>@FormatAnswer(userAnswer)</td>
            </tr>
        }
        </tbody>
    </table>

    <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-danger" @onclick="FinishExam">Завершить экзамен</button>
    </div>
</div>

@code {

    // Таблица перевода первичного → вторичного балла (ФИПИ, 2025)
    private readonly Dictionary<int, int> _primaryToSecondary = new()
    {
        { 0, 0 },
        { 1, 7 }, { 2, 14 }, { 3, 20 }, { 4, 27 }, { 5, 34 },
        { 6, 40 }, { 7, 43 }, { 8, 46 }, { 9, 48 }, { 10, 51 },
        { 11, 54 }, { 12, 56 }, { 13, 59 }, { 14, 62 }, { 15, 64 },
        { 16, 67 }, { 17, 70 }, { 18, 72 }, { 19, 75 }, { 20, 78 },
        { 21, 80 }, { 22, 83 }, { 23, 85 }, { 24, 88 },
        { 25, 90 }, { 26, 93 }, { 27, 95 }, { 28, 98 }, { 29, 100 }
    };

    private readonly Dictionary<int, string> _correctAnswers = new()
    {
        { 1, "52" },
        { 2, "zyxw" },
        { 3, "133228" },
        { 4, "16" },
        { 5, "26" },
        { 6, "251" },
        { 7, "123937" },
        { 8, "5058" },
        { 9, "901" },
        { 10, "13" },
        { 11, "257" },
        { 12, "999" },
        { 13, "191191255254" },
        { 14, "3367" },
        { 15, "24" },
        { 16, "15588" },
        { 17, "150,9930" },
        { 18, "2362,1205" },
        { 19, "124" },
        { 20, "127,128" },
        { 21, "132" },
        { 22, "12" },
        { 23, "68" },
        { 24, "2981" },
        { 25, "800004,400004,800009,114294,800013,266674,800024,400014,800033,61554" },
        { 26, "564,444" },
        { 27, "38471,61225,142058,25299" }
    };

    private readonly Dictionary<int, int> _maxPoints = new()
    {
        { 1, 1 }, { 2, 1 }, { 3, 1 }, { 4, 1 }, { 5, 1 },
        { 6, 1 }, { 7, 1 }, { 8, 1 }, { 9, 1 }, { 10, 1 },
        { 11, 1 }, { 12, 1 }, { 13, 1 }, { 14, 1 }, { 15, 1 },
        { 16, 1 }, { 17, 1 }, { 18, 1 }, { 19, 1 }, { 20, 1 },
        { 21, 1 }, { 22, 1 }, { 23, 1 }, { 24, 1 }, { 25, 1 },
        { 26, 2 }, { 27, 2 }
    };

    private int CalculatePrimaryScore()
    {
        var total = 0;
        for (var i = 1; i <= 27; i++)
        {
            var userAnswer = ExamState.Answers.GetValueOrDefault(i, "");
            var (score, _) = GetScoreAndCorrectAnswer(i, userAnswer);
            total += score;
        }

        return total;
    }

    private int ConvertToSecondary(int primary)
    {
        return _primaryToSecondary.GetValueOrDefault(primary, 0);
    }

    private (int score, string correct) GetScoreAndCorrectAnswer(int taskId, string userAnswer)
    {
        var correct = _correctAnswers.GetValueOrDefault(taskId, "—");
        var maxPoint = _maxPoints.GetValueOrDefault(taskId, 0);

        if (string.IsNullOrWhiteSpace(userAnswer))
            return (0, correct);

        if (userAnswer.Equals(correct, StringComparison.OrdinalIgnoreCase))
            return (maxPoint, correct);

        if (taskId is 17 or 18 or 20 or 26 or 27)
        {
            var userParts = userAnswer.Split(',');
            var correctParts = correct.Split(',');
            if (userParts.Length == correctParts.Length)
            {
                var correctCount = 0;
                for (var i = 0; i < userParts.Length; i++)
                {
                    if (userParts[i].Trim().Equals(correctParts[i].Trim(), StringComparison.OrdinalIgnoreCase))
                        correctCount++;
                }

                return (correctCount, correct);
            }
        }

        return (0, correct);
    }

    private static string FormatAnswer(string answer)
    {
        if (string.IsNullOrEmpty(answer))
        {
            return "—";
        }
        return answer.Contains(",") ? string.Join(", ", answer.Split(',')) : answer;
    }

    private async Task FinishExam()
    {
        await ConnectivityService.CheckUntilConnectedAsync(async () => await InvokeAsync(() => NavigationManager.NavigateTo("/")));
    }

}